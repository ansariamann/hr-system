version: "3.8"

services:
  postgres:
    container_name: ats-postgres-staging
    environment:
      POSTGRES_DB: ats_staging
      POSTGRES_USER: ats_staging_user
      POSTGRES_PASSWORD: ${STAGING_DB_PASSWORD}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data_staging:/var/lib/postgresql/data
      - ./backups/staging:/backups

  redis:
    container_name: ats-redis-staging
    ports:
      - "6380:6379"
    volumes:
      - redis_data_staging:/data

  api:
    container_name: ats-api-staging
    environment:
      ENVIRONMENT: staging
      POSTGRES_DB: ats_staging
      POSTGRES_USER: ats_staging_user
      POSTGRES_PASSWORD: ${STAGING_DB_PASSWORD}
      REDIS_DB: 1
      LOG_LEVEL: INFO
      DEBUG: "false"
      SECRET_KEY: ${STAGING_SECRET_KEY}
      BACKUP_PATH: /app/backups/staging
    ports:
      - "8001:8000"
    volumes:
      - ./backups/staging:/app/backups/staging

  worker:
    environment:
      ENVIRONMENT: staging
      POSTGRES_DB: ats_staging
      POSTGRES_USER: ats_staging_user
      POSTGRES_PASSWORD: ${STAGING_DB_PASSWORD}
      REDIS_DB: 1
      LOG_LEVEL: INFO
      SECRET_KEY: ${STAGING_SECRET_KEY}
      BACKUP_PATH: /app/backups/staging
    volumes:
      - ./backups/staging:/app/backups/staging
    deploy:
      replicas: 2

volumes:
  postgres_data_staging:
    driver: local
  redis_data_staging:
    driver: local
